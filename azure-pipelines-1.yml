# Python to Linux Web App on Azure
# Build your Python project and deploy it to Azure as a Linux Web App.
# Change python version to one thats appropriate for your application.
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnectionId: '5a4c5312-e538-4725-97d6-fe77c1d4e140'
  WEBAPP_NAME: testp
  vmImageName: 'ubuntu-latest'
  RESOURCE_GROUP: test-1
  COMPOSE_FILE_PATH: 'docker-compose.yml'
  DAGS_DIR: 'dags' 
  ZIP_FILE_NAME: 'dags.zip'

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)/$(DAGS_DIR)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/dags.zip'
              replaceExistingArchive: true
            displayName: 'Zip DAGS Directory'
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/$(ZIP_FILE_NAME)'
              artifactName: 'dagsArtifact'
            displayName: 'Publish Zipped DAGS as Pipeline Artifact'

  - stage: DeployAndUnzip
    dependsOn: Build
    jobs:
      - job: DeployAndUnzip
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifactName: 'dagsArtifact'
              path: '$(Pipeline.Workspace)/dagsArtifact'
            displayName: 'Download Zipped DAGS Artifact'
          
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Development Subscription (d8501f72-cc6e-4c07-9f8c-b8523c3b63ec)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying ZIP to Azure Web App via Kudu API..."
                
                # Define Kudu API URL for zipdeploy
                ZIPDEPLOY_URL="https://$(WEBAPP_NAME).scm.azurewebsites.net/api/zipdeploy"

                # Get Kudu API credentials
                PUBLISH_PROFILE=$(az webapp deployment list-publishing-profiles --resource-group $(RESOURCE_GROUP) --name $(WEBAPP_NAME) --query "[0]" --output json)
                USERNAME=$(echo $PUBLISH_PROFILE | jq -r .userName)
                PASSWORD=$(echo $PUBLISH_PROFILE | jq -r .userPWD)
                
                # Deploy the ZIP file using the zipdeploy API
                echo "Deploying the ZIP file to /home directory using zipdeploy API..."
                curl -X POST -u $USERNAME:$PASSWORD --data-binary @"$(Pipeline.Workspace)/dagsArtifact/$(ZIP_FILE_NAME)" $ZIPDEPLOY_URL
                
                echo "Deployment completed."
                
                # List the contents of the /home directory in Kudu
                echo "Listing the contents of the /home directory..."
                LIST_COMMAND_API_URL="https://$(WEBAPP_NAME).scm.azurewebsites.net/api/command"
                curl -X POST -u $USERNAME:$PASSWORD -H "Content-Type: application/json" -d '{"command": "ls -la /home"}' $LIST_COMMAND_API_URL
                
                # Print the current working directory using pwd
                echo "Checking the current working directory..."
                curl -X POST -u $USERNAME:$PASSWORD -H "Content-Type: application/json" -d '{"command": "pwd"}' $LIST_COMMAND_API_URL
            displayName: 'Deploy, Check Directory, and List Contents'



        

  # # Stage 3: Deploy using Docker Compose
  # - stage: Deploy
  #   dependsOn: DeployAndUnzip
  #   jobs:
  #     - job: Deploy
  #       steps:
  #         # Step 1: Deploy the web app using Docker Compose
  #         - task: AzureCLI@2
  #           inputs:
  #             azureSubscription: 'Development Subscription (d8501f72-cc6e-4c07-9f8c-b8523c3b63ec)'
  #             scriptType: 'bash'
  #             scriptLocation: 'inlineScript'
  #             inlineScript: |
  #               echo "Deploying to Azure Web App using Docker Compose..."
                
  #               # Ensure the web app exists and configure the settings
  #               az webapp config appsettings set --resource-group $(RESOURCE_GROUP) --name $(WEBAPP_NAME) --settings WEBSITES_ENABLE_APP_SERVICE_STORAGE=TRUE
                
  #               # Configure the web app to use Docker Compose from the specified file
  #               az webapp config container set --resource-group $(RESOURCE_GROUP) --name $(WEBAPP_NAME) --multicontainer-config-type compose --multicontainer-config-file $(COMPOSE_FILE_PATH)
                
  #               # Restart the web app to apply the changes
  #               az webapp restart --resource-group $(RESOURCE_GROUP) --name $(WEBAPP_NAME)
                
  #               echo "Docker Compose deployment completed."
  #           displayName: 'Deploy Docker Compose to Azure Web App'
